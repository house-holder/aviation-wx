#!/usr/bin/env bash

# CONSTANTS --------------------------------------------------------------------
G='\033[0;32m'
NC='\033[0m'

CACHE_PATH="${HOME}/.cache/aviation-wx.json"
CONFIG_PATH="${HOME}/.config/afd.cfg"

BASE_URL="https://aviationweather.gov/api/data"


# WEATHER FUNCS ----------------------------------------------------------------
discussion() {
	local cwa="kpah"
	local type="${2:-"af"}"
	local url="${BASE_URL}/fcstdisc?cwa=${cwa}&type=${type}"

	curl -s "$url"

	# if [[ $type == "af" ]]; then
	# 	curl -s "$url" | bat
	# else
	# 	curl -s "$url"
	# fi
}

metar() {
	local id="${1}"
	local format="${2:-"raw"}"
	local url="${BASE_URL}/metar?ids=${id}&format=${format}"
	curl -s "$url" && echo
}

taf() {
	local id="${1:-$default}"
	local url="${BASE_URL}/taf?ids=${id}&format=raw"
	curl -s "$url" && echo
}


# CACHING ----------------------------------------------------------------------
cache_wx() {
	local station_id=${1}

	# if station_id changes, flush cache file to a bare json object:
}

flush_cache() {
	echo "Not implemented"
	# IDEAL EMPTY CACHE STRUCTURE (EOF?):
	# {
	# 	"station": { "id": "", "coords": { "lat": 0, "lon": 0 }},
	# 	"metar": { "raw": "", "time": 0, },
	# 	"taf": { "raw": "", "time": 0, },
	# 	"af": { "raw": "", "time": 0, },
	# 	"afd": { "raw": "", "time": 0, },
	# }
}

# HELPERS ----------------------------------------------------------------------
get_station_coords() {
	local station_id=${1}
	local json_result=$(metar ${station_id} "json")
	echo $json_result
	
	# is the station cached? if so, coords are there
	
	# if cache is not the requested station, fetch new -> collect coords
	
	printf '%s\n%s\n' "$lat" "$long"
}

get_cwa() {
	local station_id=${1}

	local url="https://api.weather.gov/points/${lat},${long}"
	local json_result=$(curl -s "$url")

	echo "K$(jq -r '.properties.cwa' <<< "$json_result")"
}

check_deps() {
	if ! command -v jq &>/dev/null; then
		echo -e "Error: '${g}jq${nc}' required but not installed. Exiting..."
		exit 1
	fi
}

main() {
	check_deps

	local station_id=${1}

	case "$2" in
		x) # generic tester command
			# get_station_coords ${station_id}
			echo "CWA: $(get_cwa 37.225 -89.578)"
			;;
		af)
			discussion ${station_id}
			;;
		afd)
			discussion ${station_id} "afd"
			;;
		metar)
			metar ${station_id}
			;;
		taf)
			taf ${station_id}
			;;
		# atis)
		# 	echo "Implement ATIS"
		# 	;;
		*)
			metar ${station_id}
			taf ${station_id}
			discussion ${station_id} "afd"
			;;
	esac
}

main ${@}
